
library(mvtnorm)
library(sn)

# simplified skew normal distribution as defined in the "sn" package
# ------------------------------------------------------------------------------

psn <- function(x, xi, omega, alpha)
    log(2) + dmvnorm(x, mean=xi, sigma=omega, log=TRUE)+pnorm(alpha%*%((x-xi)/sqrt(diag(omega))), log=TRUE)

# parameters
# ------------------------------------------------------------------------------

omega <- matrix(c(16,8,8,12), 2, 2)
alpha <- c(2,6)
xi    <- c(2,3)

# xi    <- c(4.906872e+00, 6.159821e+00)
# omega <- matrix(c(2.547269e+01, 3.171179e+00, 3.171179e+00, 2.547269e+01), 2, 2)
# alpha <- c(2.447269e+01, 2.447269e+01)

# evaluate density function
# ------------------------------------------------------------------------------

psn(c(1,2), xi, omega, alpha)

psn(c(2.75594661,4.700348), xi, omega, alpha)

# plot 2D density
# ------------------------------------------------------------------------------

plot.psn <- function(x,y) {
    m <- matrix(0, length(x), length(y))
    for (i in 1:length(x)) {
        for (j in 1:length(y)) {
            m[i,j] <- exp(psn(c(x[i],y[j]), xi, omega, alpha))
        }
    }
    image(m)
}

plot.psn(seq(0.0,10,length.out=101),
         seq(0.0,10,length.out=101))

# generate samples
# ------------------------------------------------------------------------------

x <- rmsn(100, xi, omega, alpha)
plot(x)

# data used for testing the parameter estimation method
x <- matrix(c(
    2.75594661,  4.700348,
   -0.55700646,  4.045626,
    6.70045102,  3.674610,
    0.42952381,  4.101212,
    6.59284684,  5.367460,
    4.32430179,  3.184627,
    0.64598990,  3.569413,
    6.31916051,  7.392589,
    2.04675683,  4.573011,
    7.82029543,  6.803890,
    3.09984252,  6.548937,
    5.06142204,  5.826152,
    9.06984778,  7.209964,
   -0.99438799,  4.361535,
   11.69984574, 13.438881,
    3.78897263,  4.100087,
    8.35420087, 13.960256,
    9.51603257,  4.896272,
    4.81957848,  5.570699,
    1.31990180,  4.888077,
    3.30109351,  3.307942,
   -0.01949095,  3.526769,
   -3.18444607,  8.465095,
    1.26720672,  6.005733,
    7.10484035, 10.055277,
    8.42091823,  9.113072,
    2.82901870,  4.027918,
    3.67989160,  3.855179,
    4.68795951,  6.820730,
    2.22447088,  5.715902,
    2.03225583,  5.818080,
    1.14186350,  5.493555,
    5.36202013,  9.655484,
    3.07788612,  5.199181,
    1.45947293,  4.724199,
    1.21795930,  3.225744,
   -0.28696571,  5.092004,
    3.90457320,  2.226318,
    4.58833263,  8.801928,
    2.04076021,  3.820850,
    6.16063043,  8.997081,
    2.73871857,  5.590378,
    9.57869898,  4.974781,
    2.78045704,  4.056074,
    8.95642718,  4.809547,
    6.61518318,  3.951484,
    0.98639482,  4.036594,
   -0.38829448,  4.185667,
    0.77141956,  4.346939,
    7.08872957,  4.931766,
    8.01350884,  3.798782,
   10.24393395,  4.244437,
    6.16115692,  6.343796,
    6.25459661,  3.130813,
    9.58238731,  8.162158,
    4.66971461, 10.677059,
    1.84788553,  8.660729,
    4.07800430,  9.379241,
    2.35532387, 10.701049,
    5.69698130,  5.498842,
    6.76664762,  5.074391,
   -1.83894184,  6.797524,
    7.67275951,  2.300542,
    0.28096349,  5.082953,
    0.35184918,  4.592556,
    9.57474386,  6.434783,
    0.23004606,  4.184062,
    9.53220682,  6.490756,
    6.55637517,  3.465605,
    9.07388670,  3.684909,
    5.83393443,  5.814029,
    5.37473026,  5.806414,
    4.16418916,  2.899504,
    9.72103570, 11.901487,
    9.04786447,  4.096438,
    0.51391140,  2.839885,
    4.51356571,  5.757988,
    2.83698717,  3.185261,
    3.13130469,  3.450239,
    5.18343076,  8.955890,
    3.69859097,  4.213072,
    5.26235420,  4.358703,
    4.68233028,  5.065302,
    3.94351170,  6.404511,
    4.71592292,  6.136997,
    2.25378555,  4.212412,
    4.71996431,  6.459409,
    0.84005735,  7.928305,
    2.04174016,  3.677648,
    7.46328759,  3.999967,
    1.50017507,  4.298077,
    8.34068452,  7.818200,
    2.68531625,  5.439663,
    6.04408035,  3.479537,
    2.44772785,  3.766574,
    9.17260944, 10.312474,
    5.94438534,  2.761207,
    3.91245029,  6.756676,
    2.10852175,  5.465862,
    9.47711202,  7.435752 ), 2, 100)
x <- t(x)

# initial parameter values
xi    <- c(1,1)
omega <- matrix(c(2,1,1,2), 2, 2)
alpha <- c(1,1)

xi    <- c(4.906872e+00, 6.159821e+00)
omega <- matrix(c(2.547269e+01, 3.171179e+00, 3.171179e+00, 2.547269e+01), 2, 2)
alpha <- c(2.447269e+01, 2.447269e+01)

objective <- function(x) {
    n <- dim(x)[1]
    r <- 0
    for (i in 1:n) {
        r <- r + psn(x[i,], xi, omega, alpha)
    }
    r - log(n)
}

objective(x)
